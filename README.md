# Gatekeeper IP 白名单申请系统

Gatekeeper 是一个基于 Web 的 IP 白名单申请和管理系统。它旨在为需要临时或永久开放服务器特定端口访问权限的用户提供一个简单、可审计的申请流程，同时为管理员提供一个方便的审批和管理界面。

## 主要功能

*   **用户系统**:
    *   用户注册和登录功能。
    *   用户角色分为申请人 (applicant) 和审批人 (approver)。
    *   用户可以自行修改密码。
*   **申请流程**:
    *   申请人可以提交 IP 地址和端口的白名单申请。
    *   申请时需要填写申请理由。
    *   申请人可以查看自己提交的所有申请及其当前状态。
*   **审批流程**:
    *   审批人可以查看所有待处理的申请。
    *   审批人可以批准或拒绝申请。
    *   批准申请后，系统会自动调用 `iptables` 命令将相应的 IP 和端口添加到防火墙规则中。
    *   拒绝申请时，需要填写拒绝理由。
*   **管理功能**:
    *   审批人可以查看和管理系统中的所有用户。
    *   审批人可以重置任何用户的密码。

## 技术栈

*   **后端**: Go
*   **数据库**: SQLite
*   **Web 框架**: Go 标准库 `net/http`
*   **会话管理**: `gorilla/sessions`
*   **密码加密**: `golang.org/x/crypto/bcrypt`

## 环境要求

1.  **Go**: 版本 1.23.0 或更高。
2.  **C 编译器**: `go-sqlite3` 依赖 CGO，因此需要一个 C 编译器 (例如 `gcc`)。
3.  **sudo 权限**: 应用需要执行 `iptables` 命令来修改防火墙规则，因此必须以 `sudo` 权限运行。

## 安装与构建

1.  **克隆仓库** (如果您尚未下载):
    ```bash
    git clone <repository_url>
    cd Gatekeeper
    ```

2.  **构建应用**:
    在项目根目录下，运行以下命令来编译和构建应用：
    ```bash
    go build -o gatekeeper_app
    ```
    这将会生成一个名为 `gatekeeper_app` 的可执行文件。

## 如何使用

1.  **启动服务**:
    由于程序需要修改 `iptables`，请使用 `sudo` 权限运行：
    ```bash
    sudo ./gatekeeper_app
    ```
    服务启动后，会监听在 `58080` 端口。

2.  **访问系统**:
    在浏览器中打开 `http://localhost:58080`。

3.  **首次登录**:
    系统在首次启动时会自动创建一个管理员账户：
    *   **用户名**: `admin`
    *   **密码**: `admin`

    首次登录后，请立即通过“修改密码”功能更改管理员密码。

4.  **创建新用户**:
    新用户可以通过注册页面自行注册，注册后的用户默认为“申请人”角色。

5.  **提交申请**:
    使用申请人账户登录，点击“申请”导航链接，填写需要加入白名单的 IP 地址、端口和申请原因，然后提交。

6.  **审批申请**:
    使用审批人（例如 `admin`）账户登录，首页仪表盘会显示所有“待处理”的申请。点击“批准”或“拒绝”按钮进行操作。

## 最佳实践

为了安全、稳定地在生产环境中使用此系统，建议遵循以下最佳实践：

### 安全性

*   **最小化 `sudo` 权限**: 直接使用 `sudo` 运行整个 Web 应用存在安全风险。更安全的做法是为运行应用的用户配置免密 `sudo` 权限，且仅限于执行必要的 `iptables` 命令。
    *   例如，编辑 `sudoers` 文件 (`sudo visudo`)，添加类似以下的行 (请将 `your_user` 替换为实际运行应用用户名):
        ```
        your_user ALL=(ALL) NOPASSWD: /usr/sbin/iptables
        ```
*   **使用反向代理**: 不要在公网上直接暴露应用端口。建议使用 Nginx 或 Caddy 等 Web 服务器作为反向代理，并为其配置 HTTPS/TLS 证书，以确保所有通信都经过加密。
*   **保护数据库文件**: 确保 `gatekeeper.db` 数据库文件的权限设置合理，只有运行应用的用户才有权读写。
    ```bash
    chmod 600 gatekeeper.db
    ```
*   **及时更新密码**: 强制要求新用户或密码被重置的用户在首次登录后立即修改默认密码。

### 部署

*   **作为系统服务运行**: 在生产服务器上，建议将应用配置为 `systemd` 服务或其他系统服务。这可以确保应用在服务器重启后能自动运行，并在意外退出时自动重启。
*   **日志管理**: 将应用的日志输出到文件，而不是标准输出。并使用日志轮转工具 (如 `logrotate`) 来管理日志文件的大小。
*   **考虑容器化**: 使用 Docker 将应用容器化，可以简化部署流程，并确保运行环境的一致性。
