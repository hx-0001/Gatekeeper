# IP 白名单审批系统 - 需求规格文档 (v1.6)

## 1. 项目概述

### 1.1. 背景
为了在内网环境中安全地使用 Claude Code 服务，需要搭建一个中间服务器作为访问通道。为确保安全，所有访问该服务器的请求都必须经过 IP 和端口的白名单授权。

### 1.2. 目标
开发一个 Web 审批系统，用于管理访问 Claude Code 通道服务器的 IP 白名单。系统需要支持用户在线提交 IP 和端口的加白申请，并由指定的审批人进行审批。审批通过后，系统自动调用服务器的 `iptables` 命令，将申请的 IP 和端口加入防火墙的入站许可规则中。系统也应支持从白名单中移除已授权的规则。

### 1.3. 项目范围
- **范围内**:
  - 提供一个基础的 Web 界面，支持用户注册、申请、审批和移除流程。
  - 支持用户修改自己的密码，并提供管理员驱动的密码重置功能。
  - 申请时可指定端口，并支持配置默认端口。
  - 实现两级用户角色：申请人 和 审批人。
  - 审批通过后，自动执行 `iptables` 命令添加规则，并处理执行结果。
  - 支持从白名单中移除 IP 和端口规则。
  - 记录所有申请及其状态。
- **范围外**:
  - 复杂的组织架构和多级审批流。
  - 自动化的 IP 有效期管理和到期清理。
  - 详细的操作日志审计。
  - 实时通知系统（如邮件、IM 通知）。

---

## 2. 核心功能

### 2.1. 用户认证与注册
- **系统初始化**:
  - 系统首次启动时，如果数据库中没有用户，将自动创建一个默认管理员账号。
  - **账号**: `admin`
  - **密码**: `admin`
  - **角色**: `approver` (审批人)
  - **安全提示**: 强烈建议管理员首次登录后立即修改默认密码。
- **用户注册**:
  - 系统提供公开的注册页面。
  - 用户使用 `工号` 和 `密码` 进行注册。
  - **工号格式**: 必须是 `五位数字` (e.g., `12345`) 或 `一位字母加五位数字` (e.g., `a12345`)。后端需要对此格式进行严格校验。
  - **角色分配**: 所有通过此页面注册的用户，角色将默认为 `applicant` (申请人)。
- **用户登录**:
  - 用户使用工号（或 `admin`）和密码进行登录。
- **修改密码**:
  - 所有已登录的用户都可以访问“修改密码”页面。
  - 用户需要提供 `旧密码`、`新密码` 和 `确认新密码` 进行修改。
- **密码重置 (忘记密码)**:
  - 这是一个由管理员驱动的流程，不涉及邮件等自动通知。
  - **流程**:
    1. 忘记密码的用户通过线下方式 (如 IM) 联系任何一位 `approver` 角色的管理员。
    2. 管理员在“用户管理”界面找到该用户。
    3. 管理员点击“重置密码”按钮，系统会将该用户的密码重置为一个临时的、安全的默认值 (例如 `changeme123`)。
    4. 管理员将此临时密码通过线下方式告知用户。
    5. 用户使用临时密码登录，并应立即前往“修改密码”页面设置新密码。

### 2.2. IP 与端口加白申请
- **申请权限**: 所有登录用户（包括 `applicant` 和 `approver`）都可以提交申请。
- **申请页面**: 提供一个申请表单。
- **表单字段**:
  - `申请IP地址` (IP Address): 需要被加入白名单的 IP 地址。
  - `端口` (Port): 期望放通的目标端口。该字段应有一个默认值，此默认值可通过应用的配置文件或环境变量进行设置。
  - `申请理由` (Reason): 简述使用该 IP 和端口的原因。
- **提交操作**: 提交后，生成一条状态为 `pending` (待审批) 的申请记录。

### 2.3. 申请审批
- **审批列表**: 审批人登录后，可以看到一个包含所有 `pending` 状态申请的列表。
- **列表信息**: 列表中应显示申请IP、端口、申请人、申请理由和提交时间。
- **审批操作**:
  - **批准 (Approve)**:
    1. 系统在后台执行 `iptables` 添加规则的命令。
    2. **检查执行结果**: 成功则更新状态为 `approved`，失败则更新为 `execution_failed`。
  - **驳回 (Reject)**:
    1. 要求审批人必须填写驳回理由。
    2. 更新状态为 `rejected` 并保存理由。
  - **移除 (Remove)**:
    1. 对于 `approved` 状态的记录，审批人可执行移除。
    2. 系统在后台执行 `iptables` 删除规则的命令。
    3. **检查执行结果**: 成功则更新状态为 `removed`，失败则提示错误。

### 2.4. 申请历史
- **申请人视图**: 申请人可以查看自己提交的所有历史申请及其当前状态。
- **审批人视图**: 审批人可以查看系统内所有的申请记录，并对已批准的规则执行移除操作。

### 2.5. 用户管理 (审批人专属)
- 审批人可以访问一个“用户管理”页面。
- 此页面会列出系统中的所有用户及其角色。
- 审批人可以对任何用户（包括其他审批人）执行“重置密码”操作。

---

## 3. 用户角色与权限

| 功能               | 申请人 (applicant) | 审批人 (approver) |
|--------------------|:------------------:|:-----------------:|
| 注册账号           | ✅                 | ✅                |
| 登录系统           | ✅                 | ✅                |
| 修改自己的密码     | ✅                 | ✅                |
| 提交 IP 加白申请   | ✅                 | ✅                |
| 查看自己的申请历史 | ✅                 | ✅                |
| 查看所有申请历史   | ❌                 | ✅                |
| 审批申请           | ❌                 | ✅                |
| 移除已批准的规则   | ❌                 | ✅                |
| 重置用户密码       | ❌                 | ✅                |

---

## 4. 技术规格

### 4.1. 后端
- **语言**: Go
- **Web 框架**: 使用 Go 标准库 `net/http`，或一个轻量级路由库（如 `gorilla/mux` 或 `chi`）。
- **Web 端口**: `58080`
- **配置**: 支持通过环境变量或配置文件 (`config.json`) 设置默认申请端口。

### 4.2. 前端
- 使用 Go 的 `html/template` 包进行服务端渲染。
- 不需要复杂的前端框架，保持页面简洁、实用。
- 可以使用一个轻量级的 CSS 框架（如 Bootstrap, Pico.css）来美化界面。

### 4.3. IP 白名单实现
- **核心机制**: 通过 Go 的 `os/exec` 包调用 shell 命令来执行 `iptables` 操作。
- **iptables 命令**:
  - **添加规则**: `sudo iptables -A INPUT -s <IP_ADDRESS> -p tcp --dport <PORT> -j ACCEPT`
  - **删除规则**: `sudo iptables -D INPUT -s <IP_ADDRESS> -p tcp --dport <PORT> -j ACCEPT`

### 4.4. 数据存储
- 使用一个轻量级的嵌入式数据库，推荐 `SQLite`。

### 4.5. 目标环境
- **Operating System**: 本应用设计运行在 **CentOS 8.4** 环境。
- **Firewall**: CentOS 8.4 使用 `nftables` 作为其默认防火墙后端。本应用依赖其提供的 `iptables-nft` 兼容层来执行 `iptables` 命令。部署前需确保该兼容层可用。

---

## 5. 数据模型

### 5.1. `users` 表 (用户信息)
| 字段名      | 类型          | 描述                               |
|-------------|---------------|------------------------------------|
| `id`        | INTEGER       | 主键, 自增                         |
| `username`  | TEXT          | 用户名/工号 (唯一)                 |
| `password`  | TEXT          | 密码 (哈希存储)                    |
| `role`      | TEXT          | 角色 (`applicant` 或 `approver`) |

### 5.2. `applications` 表 (申请记录)
| 字段名            | 类型          | 描述                               |
|-------------------|---------------|------------------------------------|
| `id`              | INTEGER       | 主键, 自增                         |
| `user_id`         | INTEGER       | 申请人ID (外键关联 `users` 表)     |
| `ip_address`      | TEXT          | 申请的 IP 地址                     |
| `port`            | INTEGER       | 申请的端口                         |
| `reason`          | TEXT          | 申请理由                           |
| `status`          | TEXT          | 状态 (`pending`, `approved`, `rejected`, `execution_failed`, `removed`) |
| `rejection_reason`| TEXT          | 驳回理由 (仅当 status 为 `rejected` 时) |
| `created_at`      | DATETIME      | 创建时间                           |
| `updated_at`      | DATETIME      | 最后更新时间                       |

---

## 6. 非功能性需求

### 6.1. 安全性
- 必须在后端严格校验工号格式。
- 必须对所有用户输入进行校验，特别是 IP 地址和端口格式。
- 密码必须经过哈希处理后才能存入数据库。
- 严格限制 Go 应用执行 shell 命令的范围，防止命令注入。

### 6.2. 易用性
- Web 界面应清晰、直观，操作流程简单。

### 6.3. 部署
- 应用应能被编译成单个二进制文件，方便部署。
- 提供一份简单的启动脚本或说明文档，并注明对 CentOS 8.4 环境的依赖。
