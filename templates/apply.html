<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>申请白名单</title>
    <link rel="stylesheet" href="/static/css/pico.min.css">
    <script src="/static/js/common.js"></script>
</head>
<body>
    <nav class="container-fluid">
        <ul>
            <li><strong>Gatekeeper</strong></li>
        </ul>
        <ul>
            <li><a href="/">仪表盘</a></li>
            <li><a href="/apply" class="secondary">申请白名单</a></li>
            {{if .IsApprover}}
            <li><a href="/admin/users">用户管理</a></li>
            <li><a href="/admin/default-rules">默认规则</a></li>
            {{end}}
            <li><a href="/change-password">修改密码</a></li>
            <li><a href="/logout">登出</a></li>
        </ul>
    </nav>
    <main class="container">
        <article>
            <hgroup>
                <h1>新的白名单申请</h1>
                <h2>提交IP和端口以供审批。</h2>
            </hgroup>
            <form method="post">
                {{if .DefaultRules}}
                <label for="default_rule_id">选择预定义规则</label>
                <select id="default_rule_id" name="default_rule_id" onchange="populateFromRule()" required>
                    <option value="">-- 选择规则 --</option>
                    {{range .DefaultRules}}
                    <option value="{{.ID}}" data-port="{{.Port}}">
                        {{.Name}} (端口: {{.Port}}, 限制所有IP)
                    </option>
                    {{end}}
                </select>
                
                <label for="ip_address">IP地址</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="ip_address" name="ip_address" pattern="^([0-9]{1,3}\.){3}[0-9]{1,3}$" title="请输入有效的IPv4地址。" required style="flex: 1;">
                    <button type="button" onclick="fillMyIP()" class="secondary" style="white-space: nowrap;">填入我的IP</button>
                </div>
                
                <!-- 隐藏的端口字段，由规则自动填充 -->
                <input type="hidden" id="port" name="port">
                {{else}}
                <p><strong>注意：</strong>当前没有可用的预定义规则。请联系管理员创建默认规则后再申请白名单。</p>
                {{end}}
                
                <label for="reason">原因</label>
                <textarea id="reason" name="reason" required></textarea>
                
                <label for="expires_at">有效期至 (可选)</label>
                <input type="datetime-local" id="expires_at" name="expires_at" title="留空表示永久有效">
                <small>留空表示永久有效。建议设置合理的有效期以提高安全性。</small>
                
                <button type="submit">提交申请</button>
            </form>

            <script>
            function populateFromRule() {
                const select = document.getElementById('default_rule_id');
                const selectedOption = select.options[select.selectedIndex];
                
                if (selectedOption.value) {
                    const port = selectedOption.getAttribute('data-port');
                    
                    // 填充隐藏的端口字段
                    document.getElementById('port').value = port;
                    
                    // 清空IP地址并聚焦
                    document.getElementById('ip_address').value = '';
                    document.getElementById('ip_address').focus();
                } else {
                    // 清空所有字段
                    document.getElementById('port').value = '';
                    document.getElementById('ip_address').value = '';
                }
            }

            async function fillMyIP() {
                const ipInput = document.getElementById('ip_address');
                const button = event.target;
                const originalText = button.textContent;
                
                try {
                    // 禁用按钮并显示加载状态
                    button.disabled = true;
                    button.textContent = '获取中...';
                    
                    // 使用公共IP API获取外网IP
                    const response = await fetch('https://api.ipify.org?format=json');
                    const data = await response.json();
                    
                    if (data.ip) {
                        ipInput.value = data.ip;
                        // 显示成功消息
                        if (typeof showSuccess === 'function') {
                            showSuccess('已自动填入您的IP地址: ' + data.ip);
                        }
                    } else {
                        throw new Error('无法获取IP地址');
                    }
                } catch (error) {
                    console.error('获取IP失败:', error);
                    // 显示错误消息
                    if (typeof showError === 'function') {
                        showError('获取IP地址失败，请手动输入');
                    } else {
                        alert('获取IP地址失败，请手动输入');
                    }
                } finally {
                    // 恢复按钮状态
                    button.disabled = false;
                    button.textContent = originalText;
                }
            }
            </script>
        </article>
    </main>
</body>
</html>
