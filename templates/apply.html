<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>申请白名单</title>
    <link rel="stylesheet" href="/static/css/pico.min.css">
    <script src="/static/js/common.js"></script>
</head>
<body>
    <nav class="container-fluid">
        <ul>
            <li><strong>Gatekeeper</strong></li>
        </ul>
        <ul>
            <li><a href="/">仪表盘</a></li>
            <li><a href="/apply" class="secondary">申请白名单</a></li>
            {{if .IsApprover}}
            <li><a href="/admin/users">用户管理</a></li>
            <li><a href="/admin/default-rules">默认规则</a></li>
            {{end}}
            <li><a href="/change-password">修改密码</a></li>
            <li><a href="/logout">登出</a></li>
        </ul>
    </nav>
    <main class="container">
        <article>
            <hgroup>
                <h1>新的白名单申请</h1>
                <h2>提交IP和端口以供审批。</h2>
            </hgroup>
            <form method="post">
                {{if .DefaultRules}}
                <fieldset>
                    <legend>申请方式</legend>
                    <label>
                        <input type="radio" name="application_type" value="manual" checked onchange="toggleApplicationMode()">
                        手动输入 IP 和端口
                    </label>
                    <label>
                        <input type="radio" name="application_type" value="default_rule" onchange="toggleApplicationMode()">
                        选择预定义规则
                    </label>
                </fieldset>

                <div id="default-rule-section" style="display: none;">
                    <label for="default_rule_id">选择默认规则</label>
                    <select id="default_rule_id" name="default_rule_id" onchange="populateFromRule()">
                        <option value="">-- 选择规则 --</option>
                        {{range .DefaultRules}}
                        <option value="{{.ID}}" data-port="{{.Port}}" data-ip="{{.IPPattern}}" data-desc="{{.Description}}">
                            {{.Name}} (端口: {{.Port}}{{if .IPPattern}}, IP: {{.IPPattern}}{{end}})
                        </option>
                        {{end}}
                    </select>
                    <small id="rule-description"></small>
                </div>
                {{end}}

                <div id="manual-input-section">
                    <label for="ip_address">IP地址</label>
                    <input type="text" id="ip_address" name="ip_address" pattern="^([0-9]{1,3}\.){3}[0-9]{1,3}$" title="请输入有效的IPv4地址。">
                    
                    <label for="port">端口</label>
                    <input type="number" id="port" name="port" value="{{.DefaultPort}}" min="1" max="65535">
                </div>
                
                <label for="reason">原因</label>
                <textarea id="reason" name="reason" required></textarea>
                
                <label for="expires_at">有效期至 (可选)</label>
                <input type="datetime-local" id="expires_at" name="expires_at" title="留空表示永久有效">
                <small>留空表示永久有效。建议设置合理的有效期以提高安全性。</small>
                
                <button type="submit">提交申请</button>
            </form>

            <script>
            function toggleApplicationMode() {
                const isManual = document.querySelector('input[name="application_type"]:checked').value === 'manual';
                const manualSection = document.getElementById('manual-input-section');
                const defaultRuleSection = document.getElementById('default-rule-section');
                
                if (isManual) {
                    manualSection.style.display = 'block';
                    defaultRuleSection.style.display = 'none';
                    document.getElementById('ip_address').setAttribute('required', '');
                    document.getElementById('port').setAttribute('required', '');
                    document.getElementById('default_rule_id').value = '';
                } else {
                    manualSection.style.display = 'none';
                    defaultRuleSection.style.display = 'block';
                    document.getElementById('ip_address').removeAttribute('required');
                    document.getElementById('port').removeAttribute('required');
                }
            }

            function populateFromRule() {
                const select = document.getElementById('default_rule_id');
                const selectedOption = select.options[select.selectedIndex];
                const descElement = document.getElementById('rule-description');
                
                if (selectedOption.value) {
                    const port = selectedOption.getAttribute('data-port');
                    const ip = selectedOption.getAttribute('data-ip');
                    const desc = selectedOption.getAttribute('data-desc');
                    
                    document.getElementById('port').value = port;
                    if (ip) {
                        document.getElementById('ip_address').value = ip;
                        document.getElementById('ip_address').setAttribute('readonly', '');
                    } else {
                        document.getElementById('ip_address').value = '';
                        document.getElementById('ip_address').removeAttribute('readonly');
                        document.getElementById('ip_address').setAttribute('required', '');
                    }
                    
                    descElement.textContent = desc || '';
                } else {
                    document.getElementById('port').value = '{{.DefaultPort}}';
                    document.getElementById('ip_address').value = '';
                    document.getElementById('ip_address').removeAttribute('readonly');
                    document.getElementById('ip_address').setAttribute('required', '');
                    descElement.textContent = '';
                }
            }
            </script>
        </article>
    </main>
</body>
</html>
