<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>仪表盘</title>
    <link rel="stylesheet" href="/static/css/pico.min.css">
    <style>
        .status-pending { color: #FFA500; font-weight: bold; }
        .status-approved { color: #28A745; font-weight: bold; }
        .status-rejected { color: #DC3545; font-weight: bold; }
        .status-execution_failed { color: #E74C3C; font-weight: bold; background: #FADBD8; padding: 2px 6px; border-radius: 3px; }
        .status-removed { color: #6C757D; font-weight: bold; }
    </style>
    <script src="/static/js/common.js"></script>
</head>
<body>
    <nav class="container-fluid">
        <ul>
            <li><strong>Gatekeeper</strong></li>
        </ul>
        <ul>
            <li><a href="/">仪表盘</a></li>
            <li><a href="/apply">申请白名单</a></li>
            {{if .IsApprover}}
            <li><a href="/admin/users">用户管理</a></li>
            <li><a href="/admin/default-rules">默认规则</a></li>
            {{end}}
            <li><a href="/change-password">修改密码</a></li>
            <li><a href="/logout">登出</a></li>
        </ul>
    </nav>
    <main class="container">
        <h2>欢迎, {{.Username}}!</h2>

        {{if .IsApprover}}
        <section id="pending-applications">
            <h3>待处理的申请</h3>
            {{if .PendingApplications}}
            <table>
                <thead>
                    <tr>
                        <th>申请人</th>
                        <th>IP地址</th>
                        <th>端口</th>
                        <th>规则类型</th>
                        <th>原因</th>
                        <th>状态</th>
                        <th>有效期至</th>
                        <th>提交时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {{range .PendingApplications}}
                    <tr>
                        <td>{{.Username}}</td>
                        <td>{{.IPAddress}}</td>
                        <td>{{.Port}}</td>
                        <td>{{if .RuleName}}{{.RuleName}}{{else}}<em>手动</em>{{end}}</td>
                        <td>{{.Reason}}</td>
                        <td><span class="status-{{.Status}}">{{.Status}}</span></td>
                        <td>{{if .ExpiresAt}}{{.ExpiresAt.Format "2006-01-02 15:04"}}{{else}}永久{{end}}</td>
                        <td>{{.CreatedAt.Format "2006-01-02 15:04"}}</td>
                        <td>
                            {{if eq .Status "pending"}}
                            <form action="/admin/approve" method="post" style="display: inline;">
                                <input type="hidden" name="id" value="{{.ID}}">
                                <button type="submit" class="secondary">批准</button>
                            </form>
                            <form action="/admin/reject" method="post" style="display: inline;">
                                <input type="hidden" name="id" value="{{.ID}}">
                                <!-- TODO: Add a modal or separate page for rejection reason -->
                                <input type="hidden" name="reason" value="Rejected by approver.">
                                <button type="submit" class="contrast">拒绝</button>
                            </form>
                            {{else if eq .Status "execution_failed"}}
                            <form action="/admin/retry" method="post" style="display: inline;">
                                <input type="hidden" name="id" value="{{.ID}}">
                                <button type="submit" class="secondary">重试</button>
                            </form>
                            <form action="/admin/reject" method="post" style="display: inline;">
                                <input type="hidden" name="id" value="{{.ID}}">
                                <input type="hidden" name="reason" value="Manual rejection after execution failure.">
                                <button type="submit" class="contrast">拒绝</button>
                            </form>
                            {{end}}
                        </td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
            {{else}}
            <p>没有待处理的申请。</p>
            {{end}}
        </section>

        <section id="application-history">
            <h3>审批历史</h3>
            {{if .AllApplications}}
            <table>
                <thead>
                    <tr>
                        <th>申请人</th>
                        <th>IP地址</th>
                        <th>端口</th>
                        <th>规则类型</th>
                        <th>原因</th>
                        <th>状态</th>
                        <th>审批响应</th>
                        <th>有效期至</th>
                        <th>提交时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {{range .AllApplications}}
                    <tr>
                        <td>{{.Username}}</td>
                        <td>{{.IPAddress}}</td>
                        <td>{{.Port}}</td>
                        <td>{{if .RuleName}}{{.RuleName}}{{else}}<em>手动</em>{{end}}</td>
                        <td>{{.Reason}}</td>
                        <td><span class="status-{{.Status}}">{{.Status}}</span></td>
                        <td>{{if and .ApprovalResponse (eq .Status "approved")}}{{.ApprovalResponse}}{{else}}-{{end}}</td>
                        <td>{{if .ExpiresAt}}{{.ExpiresAt.Format "2006-01-02 15:04"}}{{else}}永久{{end}}</td>
                        <td>{{.CreatedAt.Format "2006-01-02 15:04"}}</td>
                        <td>
                            {{if eq .Status "approved"}}
                            <form action="/admin/remove" method="post" style="display: inline;">
                                <input type="hidden" name="id" value="{{.ID}}">
                                <button type="submit" class="contrast">移除</button>
                            </form>
                            {{end}}
                        </td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
            {{else}}
            <p>没有申请历史。</p>
            {{end}}
        </section>
        {{end}}

        <section id="my-applications">
            <h3>我的申请</h3>
            {{if .MyApplications}}
            <table>
                <thead>
                    <tr>
                        <th>IP地址</th>
                        <th>端口</th>
                        <th>规则类型</th>
                        <th>原因</th>
                        <th>状态</th>
                        <th>审批响应</th>
                        <th>有效期至</th>
                        <th>提交时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {{range .MyApplications}}
                    <tr>
                        <td>{{.IPAddress}}</td>
                        <td>{{.Port}}</td>
                        <td>{{if .RuleName}}{{.RuleName}}{{else}}<em>手动</em>{{end}}</td>
                        <td>{{.Reason}}</td>
                        <td><span class="status-{{.Status}}">{{.Status}}</span></td>
                        <td>
                            {{if eq .Status "approved"}}
                                {{if .ApprovalResponse}}{{.ApprovalResponse}}{{else}}-{{end}}
                            {{else if eq .Status "pending"}}
                                <em style="color: #6C757D;">审批响应通过后可查看</em>
                            {{else if eq .Status "rejected"}}
                                <em style="color: #6C757D;">审批响应通过后可查看</em>
                            {{else if eq .Status "execution_failed"}}
                                <em style="color: #6C757D;">审批响应通过后可查看</em>
                            {{else}}
                                <em style="color: #6C757D;">审批响应通过后可查看</em>
                            {{end}}
                        </td>
                        <td>{{if .ExpiresAt}}{{.ExpiresAt.Format "2006-01-02 15:04"}}{{else}}永久{{end}}</td>
                        <td>{{.CreatedAt.Format "2006-01-02 15:04"}}</td>
                        <td>
                            {{if and (eq .Status "approved") $.IsApprover}}
                            <form action="/admin/remove" method="post">
                                <input type="hidden" name="id" value="{{.ID}}">
                                <button type="submit" class="contrast">移除</button>
                            </form>
                            {{end}}
                        </td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
            {{else}}
            <p>您还没有提交任何申请。</p>
            {{end}}
        </section>
    </main>
</body>
</html>
